---
title: "Homework Assignment 4"
subtitle: "Interactive and animated plots<br><br>" 
author: 
  - "Byeong-Hak Choe<br>"
date: "`r Sys.Date()`<br><br>"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
    highlight: espresso
---
```{r, include=FALSE}
library(tidyverse)
```


Publish your web-page in your personal website on GitHub, just like this web-page, by 1:00 P.M., April 28. But, if you need an extension, let me know!

- For each section, provide both R codes to produce interactive/animated plots and the outputs of your R codes.

- The title of each Section is the name of R package you need for this homework.

# `gganimate`

The following link is for the data that is used to generate the figure in this Section.
```{r, echo = T, message=F, warning=F}
imf_growth <- read_csv(url('https://bcdanl.github.io/data/imf_growth_quarterly.csv'))

# gy: growth rate of GDP per worker 
library(gganimate)
growth_formatted <- imf_growth %>%
  group_by(date) %>%
  # The * 1 makes it possible to have non-integer ranks while sliding
  mutate(rank = rank(-gy),
         Value_rel = gy/gy[rank==1],
         Value_lbl = paste0(" ",round(gy, 2)),
         Value_lbl2 = ifelse(gy<= 0, NA, Value_lbl)) %>%
  group_by(country) %>% 
  ungroup()


static <- ggplot(growth_formatted, aes(rank, group = country, 
                                       fill = as.factor(country), 
                                       color = as.factor(country))) +
  geom_tile(aes(y = gy/2,
                height = gy,
                width = 0.9), alpha = 0.8, color = NA) +
  geom_text(data = filter(growth_formatted, gy >= 0),
            aes(y = 0, label = paste(country, " ")), 
            vjust = 0.2, hjust = 1) +
  geom_text(data = filter(growth_formatted, gy >= 0),
            aes(y=gy,label = Value_lbl, hjust=0)) +
  geom_text(data = filter(growth_formatted, gy < 0),
            aes(y = 0, label = paste(country, " ")), 
            vjust = 0.2, hjust = 0) +
  geom_text(data = filter(growth_formatted, gy < 0),
            aes(y=gy,label = Value_lbl, hjust=1)) +
  coord_flip(clip = "off", expand = FALSE) +
  scale_y_continuous(labels = scales::comma,
                     limits=c(min(growth_formatted$gy),max(growth_formatted$gy)), 
                     breaks=seq(min(growth_formatted$gy), max(growth_formatted$gy), 10)) +
  scale_x_reverse() +
  guides(color = "none", fill = "none") +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.x = element_line( size=.1, color="grey" ),
        panel.grid.minor.x = element_line( size=.1, color="grey" ),
        plot.title=element_text(size=25, hjust=0.5, 
                                face="bold", colour="grey", vjust=0),
        plot.subtitle=element_text(size=18, hjust=0.5, face="italic", color="grey"),
        plot.caption =element_text(size=8, hjust=0.5, face="italic", color="grey"),
        plot.background=element_blank(),
        plot.margin = margin(2,2, 2, 4, "cm")) 


anim <-  static + transition_states(qt, 
                                        transition_length = 4, 
                                        state_length = 1) +
  view_follow(fixed_x = TRUE)  +
  labs(title = 'Growth Rate of GDP per worker : {closest_state}',  
       caption  = "Data Source: IMF")


# animate(anim, 200, fps = 6,  width = 1200, height = 1000, 
        # renderer = gifski_renderer("gganim_imf_gdp_growth.gif"))

knitr::include_graphics('lec_figs/gganim_imf_gdp_growth.gif')


```



<!-- ![](/Users/byeong-hakchoe/Documents/website/bcdanl.github.io/lec_figs/gganim_imf_gdp_growth.gif) -->

The effect of the COVID-19 Pandemic on economic growth can be observed in the animation above. 


# `ggiraph`
The following link is for the data that is used to generate the figure in this Section.

```{r, echo = T, message = F, warning = F}
climate_opinion <- read_csv(
  'https://bcdanl.github.io/data/climate_opinion_2021.csv')
# Variable `human` is a percentage of people who believe that global warming is mostly caused by human activity.
```


```{r, echo = T, message = F, warning = F}
library(socviz)
county_map <- county_map
county_map$id <- as.integer(county_map$id)
county_full <- left_join(county_map, climate_opinion)


na_map <- function(yr){
  county_full_na <- filter(county_full, is.na(belief)) %>% 
    select(-belief) %>% 
    mutate( belief = yr)
}

for (val in  levels( factor(county_full$belief) )  ){
  county_full <- rbind(county_full, na_map(val))
}

county_full <- county_full %>% 
  mutate(belief_desc = ifelse(belief == "happening",
                              "Global warming is happening.",
                              "Global warming is mostly caused by human activities."))

county_full$GeoName <-
  iconv( x = county_full$GeoName
         , from = "UTF-8"
         , to = "UTF-8"
         , sub = "" )

library(ggiraph)
library(ggthemes)
p1 <- ggplot(data = filter(county_full, !is.na(belief),
                           belief == "human")) + 
  geom_polygon_interactive(mapping = aes(x = long, y = lat, 
                             group = group, fill = perc,
                             tooltip = str_c(GeoName,
                                             as.character(perc),
                                             sep = '\n'),
                             data_id = perc),
                              color = "grey60", size = 0.1) 


p2 <- p1 + scale_fill_gradient2( 
  low = '#2E74C0',  
  high = '#CB454A',  
  mid = 'white', # transparent white
  na.value = "grey80",
  midpoint = 50,
  breaks = c(quantile(climate_opinion$human, 0, na.rm = T),
             quantile(climate_opinion$human, .25, na.rm = T),
             quantile(climate_opinion$human, .5, na.rm = T),
             quantile(climate_opinion$human, .75, na.rm = T),
             quantile(climate_opinion$human, 1, na.rm = T)),
  labels = c(paste(round(quantile(climate_opinion$human, 0, na.rm = T), 1),"\n(Min)"),
             paste(round(quantile(climate_opinion$human, .25, na.rm = T), 1),"\n(25th)"),
             paste(round(quantile(climate_opinion$human, .5, na.rm = T), 1),"\n(50th)"),
             paste(round(quantile(climate_opinion$human, .75, na.rm = T), 1),"\n(75th)"),
             paste(round(quantile(climate_opinion$human, 1, na.rm = T), 1),"\n(Max)")
  ),
  guide = guide_colorbar( direction = "horizontal",
                          barwidth = 25,
                          title.vjust = 1 )
) 

p <- p2 + labs(fill = "Percent\nBelief", title = "U.S. Climate Opinion, 2021",
          caption = "Sources: Yale Program on Climate Change Communication\n(https://climatecommunication.yale.edu/visualizations-data/ycom-us/)") +
  theme_map() + 
  facet_wrap(.~ belief_desc) +
  theme(plot.margin = unit( c(1, 1, 3.85, 0.5), "cm"),
        legend.position = c(0.5, -.15),
        legend.justification = c(.5,.5),
        strip.background = element_rect( colour = "black",
                                         fill = "white",
                                         color = "grey80" )
  ) +
  guides(fill = guide_colourbar(direction = "horizontal", barwidth = 25,
                                title.vjust = 1))


widg <- ggiraph(ggobj = p, width_svg = 8, height_svg = 8)
widg

# save the widget
# library(htmlwidgets)
# saveWidget(widg, file=paste0( getwd(), "/climate_opinion_map_interactive.html"))


# ````{=html}
# ```{r, echo = T, echo=FALSE, results='asis'}
# xfun::file_string('/Users/byeong-hakchoe/Documents/website/bcdanl.github.io/climate_opinion_map_interactive.html')
# ```
# ````
```

You can click the county on the map and see the percentage level and the name of the county.

<br>

Here we observe the differences in public opinion about human-cased climate change in the U.S.

<br>

References for this homework are

  - [Fundamentals of Data Visualization by Claus O. Wilke](https://clauswilke.com/dataviz)
  - [Data Visualization: A practical introduction by Kieran Healy](https://socviz.co)




<!-- ````{=html} -->
<!-- ```{r, echo = T, echo=FALSE, results='asis'} -->
<!-- xfun::file_string('/Users/byeong-hakchoe/Documents/website/bcdanl.github.io/climate_opinion_map_interactive.html') -->
<!-- ``` -->
<!-- ```` -->

