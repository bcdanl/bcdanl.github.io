---
title: "DANL 310: Data Visualization and Presentation<br>Homework Assignment 2"
author: "Byeong-Hak Choe"
execute: 
  echo: true
  eval: true
---

```{r setup}
#| include: false
library(tidyverse)
library(gapminder)
library(skimr)   # a better summary of data.frame
library(scales)  # scales for ggplot
library(ggthemes)  # additional ggplot themes
library(hrbrthemes) # additional ggplot themes and color pallets
library(lubridate)
library(ggridges)
library(ggrepel)
theme_set(theme_minimal()) # setting the minimal theme for ggplot
# setting default chunk options
knitr::opts_chunk$set(
	# eval = T,
	# echo = F,
	message = FALSE,
	warning = FALSE
)
```

# Question 1

Add a web-page of the project proposal to your website. 

<br><br>

# Question 2

Provide ggplot codes to replicate the given figure.

## Q2a.

Use the following data.frame for Q2a, Q2b, and Q2c.

```{r}
hdi_corruption <- read_csv(
  'https://bcdanl.github.io/data/hdi_corruption.csv')
```

```{r}
hdi_corruption <- read_csv(
  'https://bcdanl.github.io/data/hdi_corruption.csv')

# Use geom_smooth(method = lm, formula = "y ~ log(x)", se = F) .
# `box.padding` option would be useful for geom_text_repel().


country_highlight <- c("Germany", "Norway", "United States", 
                       "Greece", "Singapore", 
                       "Argentina", "Senegal",
                       "China", "Egypt", "South Africa")

corruption <- hdi_corruption %>% 
  mutate(label = ifelse(country %in% country_highlight, country, NA))


ggplot(data = filter(corruption, year == 2014), aes(cpi, hdi)) + 
  geom_smooth(method = lm, formula = "y ~ log(x)", se = F) + 
  geom_point(
    aes(color = region, fill = region),
    size = 2.5, alpha = 0.5, shape = 21
  ) + 
  geom_text_repel(
    aes(label = label), color = "black", size = 4,
    box.padding = .75
  ) +
  scale_y_continuous(
    limits = c(0.3, 1.05), breaks = c(0.2, 0.4, 0.6, 0.8, 1.0),
    name = "Human Development Index, 2014\n(1.0 = most developed)"
  ) +
  scale_x_continuous(
    limits = c(10, 95),
    breaks = c(20, 40, 60, 80, 100),
    name = "Corruption Perceptions Index, 2014 (100 = least corrupt)"
  ) + 
  theme_minimal() + 
  theme(
    plot.margin = unit( c(1.75, .75, .75, .5), "cm"),
    legend.position = c(.5, 1.05),
    legend.direction = "horizontal",
    legend.text = element_text(size = 10)
  ) +
  labs( color = "Region", fill = "Region") 

```

<br><br>

## Q2b

-   Download the file `labor_supply.zip` from the Google Drive. Then, extract `labor_supply.zip`, so that you can access the `labor_supply.csv` file.

-   Variable description in `labor_supply.csv`

    -   `SEX`: 1 if Male; 2 if Female; 9 if NIU (Not in universe)
    -   `NCHLT5`: Number of own children under age 5 in a household; 9 if 9+
    -   `LABFORCE`: 0 if NIU or members of the armed forces; 1 if not in the labor force; 2 if in the labor force.
    -   `ASECWT`: sample weight
    
    
- A sample weight of each observation means how much population each observation represents.
  - If you sum `ASECWT` for each year, you get the size of yearly population in the US.
  
  
- Households with `LABFORCE == 0` is not in labor force.


- Labor force participation rate can be calculated by:

$$
(\text{Labor Force Participation Rate}) \, = \, \frac{(\text{Size of population in labor force})}{(\text{Size of civilian population that are not members of the armed force})}
$$

```{r, fig.width= 8, fig.height= 8}
path <- '/Users/bchoe/My Drive/suny-geneseo/teaching-materials/lecture-data/labor_supply.csv'

cps_labor <- read_csv(path)

cps_labor <- cps_labor %>% 
  filter(YEAR >= 1982) %>% 
  filter(LABFORCE != 0) %>% 
  mutate(LABFORCE = LABFORCE - 1) %>% 
  mutate(labor_supply = LABFORCE * ASECWT,
         child = ifelse(NCHLT5 == 0, 
                        "No Child Under Age 5 in Household", 
                        "Having Children Under Age 5 in Household")) %>% 
  group_by(YEAR, SEX, child) %>% 
  summarize(pct = sum(labor_supply) / sum(ASECWT, na.rm= T) ) %>% 
  filter(!is.na(child))
  
label_df <- filter(cps_labor, YEAR == 2022) %>% 
  mutate(label = ifelse(SEX == 1, "Male", "Female"))

ggplot(data = cps_labor,
       aes(x = YEAR, y = pct, 
           color = factor(SEX))) +
  geom_line(size = 1.5) +
  geom_label_repel(data = label_df,
                  aes(x = YEAR, y = pct, label = label),
                  color = 'black',
                  nudge_y = .033, box.padding = .5) +
  facet_grid( . ~ factor(child)) +
  scale_x_continuous( breaks = seq(1982, 2022, 4) ) +
  scale_y_continuous( labels = scales::percent) +  
  scale_color_manual( labels = c("Male", "Female"),
                      values = c("#2E74C0", "#CB454A") ) +
  labs(x = "Year",
       y = "Labor Force Participation Rate",
       color = "Gender",
       lty = "Young Children",
       title = "Fertility and Labor Supply in the U.S.",
       subtitle = "1982-2022",
       caption = "Data: IPUMS-CPS, University of Minnesota, www.ipums.org.") +  guides(color = "none") +
  theme_ipsum() +
  theme(axis.title.y = element_text(size = rel(1.5),
                                    face = 'bold'),
        axis.text.x = element_text(angle = 45))
```

<br><br>

## Q2c

```{r, echo = T, eval = F}
library(ggcorrplot) # to create correlation heatmaps using ggcorrplot()

beer_mkt <- read_csv('https://bcdanl.github.io/data/beer_markets.csv')
```

-   Make a correlation heat-map with variables that are either strongly correlated or `promo`-related.
  - The variables are selected by how high the mean value of the absolute value of correlations with the variable is (top 13-15 variables).
  - You can start with the data.frame, `beer_dummies`:
```{r, eval = F, echo = T}

beer_dummies <- beer_mkt %>% select(-hh, -market) 
reg <- lm(data = beer_dummies,
          beer_floz ~ .)
beer_dummies <-  as.data.frame(model.matrix(reg))[, -1]
beer_dummies <- cbind(beer_mkt$beer_floz ,beer_dummies)
beer_dummies <- beer_dummies %>% 
  rename(beer_floz = `beer_mkt$beer_floz`)
```


```{r}

library(tidyverse)
library(ggfortify) # to create regression-related plots
library(ggcorrplot) # to create correlation heatmaps
library(fastDummies) # to create dummy variables
beer_mkt <- read.csv('https://bcdanl.github.io/data/beer_markets.csv')
results <- fastDummies::dummy_cols(beer_mkt %>% select(-hh, -market) )
colnames(results)

results <- results %>% 
  select(dollar_spent,
         beer_floz,
         price_per_floz,
         starts_with("brand_"),
         `container_NON REFILLABLE BOTTLE`,
         starts_with("promo"),
         buyertype_married,
         children6to17,
         `age_50+`,
         employment_none) %>% 
  mutate(promo = as.integer(promo),
         children6to17 = as.integer(children6to17)) %>% 
  rename(`NON REFILLABLE BOTTLE` = `container_NON REFILLABLE BOTTLE`)

colnames(results) <- str_replace_all(colnames(results), 
                                     "brand_", "") 
colnames(results)

cor_beer <- cor(results)
class(cor_beer)

cor_beer <- as.data.frame(cor_beer)

```


```{r}
p <- ggcorrplot( cor_beer, lab = T,
            colors = c("#2E74C0", "white", "#CB454A"),
) +
  theme(axis.text = element_text(size = rel(1.5),
                                 face = 'bold'))  + 
  guides(fill = guide_colourbar(barheight = 38.5))

p

```



- To calculate a correlation between numeric variables in `data.frame`, use `cor(data.frame)`

```{r, fig.align='center'}
#| echo: false
knitr::include_graphics('beer_cor.jpg')
```

-   Then, make a correlation heat-map for NY markets with the same selection of variables.

- NY markets are such that whose `market` value is either `ALBANY`, `BUFFALO-ROCHESTER`, `URBAN NY`, `SUBURBAN NY`, `EXURBAN NY`, `RURAL NEW YORK`, or `SYRACUSE`.
```{r, fig.align='center'}
#| echo: false
knitr::include_graphics('beer_cor_ny.jpg')
```

<!-- References: -->

<!-- -   [Fundamentals of Data Visualization by Claus O. Wilke](https://clauswilke.com/dataviz) -->
<!-- -   [Data Visualization: A practical introduction by Kieran Healy](https://socviz.co) -->
