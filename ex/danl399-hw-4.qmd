---
title: "DANL 310: Data Visualization and Presentation<br>Homework Assignment 4"
author: "Byeong-Hak Choe"
execute: 
  echo: true
  eval: true
  warning: false
  message: false
  fig-width: 9
---


```{r setup}
#| include: false
library(tidyverse)
library(knitr)
library(kableExtra)
library(ggthemes)
library(ggthemr)
library(ggthemes)
library(hrbrthemes)
library(hexbin)
library(ggforce)
library(skimr)

knitr::opts_chunk$set(fig.width=8, fig.height=5,
                      echo = T, eval = T, message=F, warning = F)  

theme_set(theme_ipsum() +
          theme(strip.background =element_rect(fill="lightgray")))
```

### Loading R packages

```{r}
#| eval: false
library(tidyverse)
library(socviz)
library(lubridate)
library(geofacet)
```

# Question 1 - Unemployment Rate Maps with `geofacet::facet_geo()`

The following data is for Question 1:

```{r}
#| echo: true
#| eval: true
unemp_house_prices <- read_csv(
  'https://bcdanl.github.io/data/unemp_house_prices.csv')

```


```{r, result = 'asis', echo = F, message = F, warning = F}
#| echo: false

rmarkdown::paged_table(unemp_house_prices) 
```

-   Use `geom_area()`, `geom_line()`, and `facet_geo(~state, labeller = adjust_labels)` to replicate the following figure

```{r}

adjust_labels <- as_labeller(
  function(x) {
    case_when(
      x == "New Hampshire" ~ "N. Hampshire",
      x == "District of Columbia" ~ "DC",
      TRUE ~ x
    )
  }
)
```

```{r}
#| echo: true
#| eval: false

unemp_house_prices %>% 
  filter(
    date >= ymd("2008-01-01")
  ) %>%
  ggplot(aes(date, unemploy_perc)) + 
  geom_area(fill = "#56B4E9", alpha = 0.7) +
  geom_line() + 
  scale_y_continuous(
    name = "unemployment rate",
    limits = c(0, 16),
    breaks = c(0, 5, 10, 15),
    labels = c("0%", "5%", "10%", "15%")
  ) +
  scale_x_date(
    name = NULL,
    breaks = ymd(c("2009-01-01", "2011-01-01", 
                   "2013-01-01", "2015-01-01", "2017-01-01")),
    labels = c("'09", "'11", "'13", "'15", "'17")
  ) +
  facet_geo(~state, labeller = adjust_labels) +
  theme(
    strip.text = element_text(
      margin = margin(3, 3, 3, 3)
    ),
    axis.line.x = element_blank()
  )
```

```{r}
#| echo: false
#| eval: true

knitr::include_graphics("statemap-unemp.png")
```


<br><br><br>

# Question 2 - Election maps and data clearning

The following data is for Question 2:

```{r}
#| echo: true
#| eval: true

election_panel <- read_csv(
  'https://bcdanl.github.io/data/election_panel.csv')

```

```{r}
#| result: asis
#| echo: false
rmarkdown::paged_table(election_panel) 
```

-   Replicate the following map.
    -   Do not use `coord_map(projection = "albers", lat0 = 39, lat1 = 45)`.

```{r}
#| echo: true
#| eval: false
election_panel_AK <- filter(election_panel,
                            state_po == "AK")

class(county_map$id)

county_map <- county_map
county_map$id <- as.integer(county_map$id)
election_panel$id <- as.integer(election_panel$id)
county_map_AK <- filter(county_map,
                            id >=2000, id < 3000)
  
county_full <- left_join(county_map, election_panel, by = "id")
county_full_AK <- filter(county_full,
                        id >=2000, id < 3000)
county_full <- county_full %>% 
  arrange(year, county_fips, order)


na_map <- function(yr){
  county_full_na <- filter(county_full, is.na(year)) %>% 
    select(-year) %>% 
    mutate( year = yr)
}

county_full_NAmap <- county_full
for (val in as.numeric(levels(factor(county_full$year)))){
  county_full_NAmap <- rbind(county_full_NAmap, na_map(val))
}

p1 <- ggplot() + geom_polygon(data = filter(county_full_NAmap, !is.na(year)), 
                       mapping = aes(x = long, y = lat, group = group, 
                                     fill = pct_DEMOCRAT ),
                       color = "grey60", size = 0.1) 

p2 <- p1 + scale_fill_gradient( 
  # low = '#CB454A',  # from party_colors for GOP
  low = '#FFFFFF',  # transparent white
  high = '#2E74C0',  # from party_colors for DEM
  na.value = "grey80",
  # midpoint = quantile(county_full$pct_DEMOCRAT, .5, na.rm = T),
  breaks = c(quantile(county_full$pct_DEMOCRAT, 0, na.rm = T),
             quantile(county_full$pct_DEMOCRAT, .25, na.rm = T),
             quantile(county_full$pct_DEMOCRAT, .5, na.rm = T),
             quantile(county_full$pct_DEMOCRAT, .75, na.rm = T),
             quantile(county_full$pct_DEMOCRAT, 1, na.rm = T)),
  labels = c(paste(round(quantile(county_full$pct_DEMOCRAT, 0, na.rm = T), 1),"\n(Min)"),
             paste(round(quantile(county_full$pct_DEMOCRAT, .25, na.rm = T), 1),"\n(25th)"),
             paste(round(quantile(county_full$pct_DEMOCRAT, .5, na.rm = T), 1),"\n(Median)"),
             paste(round(quantile(county_full$pct_DEMOCRAT, .75, na.rm = T), 1),"\n(75th)"),
             paste(round(quantile(county_full$pct_DEMOCRAT, 1, na.rm = T), 1),"\n(Max)")
  ),
  guide = "colourbar"
  ) 

p2 + labs(fill = "Percent\nDemocrat",
          title = "U.S. Presidential Election, 2000-2020") +
  theme_map() + 
  facet_wrap(.~ year) +
  theme(plot.margin = unit( c(1, 1, 4, 0.5), "cm"),
        legend.position = c(0.5, -.15),
        legend.justification = c(.5,.5),
        strip.background = element_rect(fill = "#e1ecf8", 
                                        colour = "black", size = .1)
        ) +
  guides(fill = guide_colourbar(direction = "horizontal", barwidth = 25,
                                title.hjust = -1, title.vjust = 1))
```

```{r}
#| echo: false

knitr::include_graphics("election-map-facet.png")
```
