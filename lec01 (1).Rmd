---
title: "Lecture"
author: Byeong-Hak Choe
date: February 4, 2022
---

This is an example of the lecture on estimating price elasticity via the model of linear regression with interaction terms using data for orange juice sales. The example is taken from the book, "[Business Data Science: Combining Machine Learning and Economics to Optimize, Automate, and Accelerate Business Decisions](https://www.amazon.com/Business-Data-Science-Combining-Accelerate/dp/1260452778)," and modified by Byeong-Hak Choe.

&nbsp;


## Price elasticity of demand

- Price elasticity of demand  measures how sensitive the quantity demanded is to its price.

&nbsp;
<center>
$\texttt{Price elasticity of demand} = \dfrac{\texttt{% Change in quantity demanded}}{\texttt{% Change in price}}$
</center>

&nbsp;

- The concept of elasticity will play an important role in industries.

  - Marketers need to understand how consumers are sensitive to fluctuations in price.

## Loading R packages and orange juice data
```{r, echo = TRUE, eval = TRUE, out.height = "75%", fig.align='center'}
library(tidyverse)  # ggplot and more
theme_set(theme_minimal()) # minimal theme for ggplot
library(skimr) # a better summary of data
library(stargazer)  # regression tables
library(moderndive) # geom_parallel_slopes()

oj <- read.table(
  'https://bcecon.github.io/dominick_oj.csv',
  sep = ',',
  header = TRUE,
  stringsAsFactor = TRUE
)
```

&nbsp;

- We will use weekly sales data for orange juice (OJ) from Dominickâ€™s grocery stores in the 1990s.


# Descriptive statistics

## OJ data
```{r, echo = TRUE, eval = TRUE, out.height = "75%", fig.align='center'}
head(oj)
levels(oj$brand)
```


## Descriptive statistics
```{r, include=FALSE}
skimmed <- skim(oj)
skimmed <- skimmed %>% 
  select(-factor.ordered, -complete_rate)
skimmed <- as_tibble(skimmed)
skimmed_chr <- skimmed[1,2:5]
skimmed_chr <- skimmed_chr %>% 
  rename(Variable = skim_variable) %>% 
  rename(n_Categories = factor.n_unique) %>% 
  rename(Counts = factor.top_counts) 
skimmed_chr[1,4] <- "dominicks: 9649,  minute.maid: 9649,  tropicana: 9649"
skimmed_numeric <- skimmed[2:4,c(2:3,5:13)]
skimmed_numeric[,4:10] <- round(skimmed_numeric[,4:10], 2)
skimmed_numeric <- skimmed_numeric %>% 
  rename(Mean = numeric.mean) %>% 
  rename(SD = numeric.sd) %>% 
  rename(Min = numeric.p0) %>% 
  rename(Q1 = numeric.p25) %>% 
  rename(Median = numeric.p50) %>% 
  rename(Q3 = numeric.p75) %>% 
  rename(Max = numeric.p100) %>% 
  rename(Hist = numeric.hist) %>% 
  rename(Variable = skim_variable) %>% 
  select(-factor.top_counts)
```

```{r, echo = TRUE, eval = TRUE, out.height = "75%", fig.align='center'}
knitr::kable(skimmed_chr, "simple")   # from skimr::skim()
```

```{r, echo = TRUE, eval = TRUE, out.height = "75%", fig.align='center'}
knitr::kable(skimmed_numeric, "simple")   # from skimr::skim()
```

# Visualizing OJ data

## Distribution of OJ prices

- It is better to use a logarithmic scale when percent change matters.

```{r, echo = TRUE, eval = TRUE, fig.height = 3.75, fig.align='center'}

ggplot(data = oj) + 
  geom_boxplot( aes( y = log(price), color = brand )) +
  theme(axis.text.x = element_blank(), axis.ticks = element_blank())

```


## Distribution of OJ sales

```{r, echo = TRUE, eval = TRUE, fig.height = 4, fig.align='center'}

ggplot(data = oj) + 
  geom_boxplot( aes( y = log(sales), color = brand )) +
  theme(axis.text.x = element_blank(), axis.ticks = element_blank())
```

## Supply and demand for OJ
```{r, echo = TRUE, eval = TRUE, fig.height = 4, fig.align='center', warning = FALSE, message = FALSE}
ggplot(data = oj, aes( x = log(price), y = log(sales), 
                       color = brand )) + 
  geom_point( alpha = .25 ) 
```


# Regression models

## Regression model with brand dummies
- The regression model for price elasticity of OJ demand can be written as:

<center>
$\log(\texttt{sales}) = \alpha_{\texttt{brand}} + \beta\log(\texttt{price}) + \epsilon$
</center>

&nbsp;

- Here $\alpha_{\texttt{brand}}$ is shorthand for a separate indicator for each OJ brand:

<center>
$\alpha_{\texttt{brand}} = \alpha_{\texttt{d}}1_{\texttt{[brand=dominicks]}}+\alpha_{\texttt{m}}1_{\texttt{[brand=minut.emaid]}}+\alpha_{\texttt{t}}1_{\texttt{[brand=tropicana]}}$
</center>

&nbsp;

- Here $\beta$ measures the price elasticity of OJ demand:

<center>
$\beta = \dfrac{\Delta\log(\texttt{sales})}{\Delta\log(\texttt{price})}\\\hspace{.25cm}  = \texttt{(% change in sales)} / \texttt{(% change in price)}$
</center>



## Run the model 

```{r results = "asis", echo = TRUE, eval = FALSE, fig.height = 4, fig.align='center'}

reg_oj1 <- lm(log(sales) ~ log(price) + brand, 
             data=oj)
stargazer(reg_oj1, type = "html", omit = c("Constant"))
```


## Run the model {.smaller}

```{r results = "asis", echo = FALSE, eval = TRUE, fig.height = 4, fig.align='center'}

reg_oj1 <- lm(log(sales) ~ log(price) + brand, 
             data=oj)
stargazer(reg_oj1, type = "html", omit = c("Constant"))
```


## Regression lines

```{r, echo = TRUE, eval = TRUE, fig.height = 4, fig.align='center'}

ggplot(data = oj, aes(x = log(price), y = log(sales), 
                      color = brand )) +
  geom_point(size = .75, alpha = 0.25) +
  geom_parallel_slopes()

```


## Regerssion model with interaction terms

- How does consumer price sensitivity change across brands?

&nbsp;

- The new regression model can be written as:

<center>
$\log(\texttt{sales}) = \alpha_{\texttt{brand}} + \beta_{\texttt{brand}}\log(\texttt{price}) + \epsilon$
</center>

&nbsp;

- Here $\beta_{\texttt{brand}}$ is shorthand for the brand-specific price elasticity:

<center>
$\beta_{\texttt{brand}} = \hspace{.1cm}\beta_{\texttt{d}}1_{\texttt{[brand=dominicks]}}+\beta_{\texttt{m}}1_{\texttt{[brand=minutemaid]}}+\beta_{\texttt{t}}1_{\texttt{[brand=tropicana]}}\hspace{.1cm}$
</center>


## Run the model

```{r, echo = TRUE, eval = FALSE, fig.height = 4, fig.align='center'}

reg_oj2 <- lm(log(sales) ~ log(price)*brand, 
             data=oj)
stargazer(reg_oj1, reg_oj2, type = "html", omit = c("Constant"))
```

## Result {.smaller}

```{r results = "asis", echo = FALSE, eval = TRUE, out.height = "50%", fig.align='center'}

reg_oj2 <- lm(log(sales) ~ log(price)*brand, 
             data=oj)
stargazer(reg_oj1, reg_oj2, type = "html", omit = c("Constant"))
```


## Regression lines

```{r, echo = TRUE, eval = TRUE, fig.height = 4, fig.align='center', warning=FALSE, message=FALSE}

ggplot(data = oj, aes(x = log(price), y = log(sales), 
                      color = brand )) +
  geom_point(size = .75, alpha = 0.25) +
  geom_smooth(method = lm, se=FALSE)

```



## Advertisement effect

- How does consumer price sensitivity change with advertisement?

  - In a brand-specific manner?

&nbsp;

- The new regression model can be written as:

<center>
$\log(\texttt{sales}) = \alpha_{\texttt{brand,feat}} + \beta_{\texttt{brand,feat}}\log(\texttt{price}) + \epsilon$
</center>

&nbsp;

- Here $\beta_{\texttt{brand}}$ measures the brand-feat-specific price elasticity:

<center>
$\beta_{\texttt{brand,feat}} = \hspace{.3cm}(\hspace{.1cm} \beta_{\texttt{d,no_ad}}1_{\texttt{[brand=dominicks]}}+\beta_{\texttt{m,no_ad}}1_{\texttt{[brand=minutemaid]}}\\\hspace{3cm}+\beta_{\texttt{t,no_ad}}1_{\texttt{[brand=tropicana]}}\hspace{.1cm})\times1_{\texttt{[feat=0]}}\\   \hspace{2cm} + (\hspace{.1cm}\beta_{\texttt{d,ad}}1_{\texttt{[brand=dominicks]}}+\beta_{\texttt{m,ad}}1_{\texttt{[brand=minutemaid]}}\\\hspace{3cm}+\beta_{\texttt{t,ad}}1_{\texttt{[brand=tropicana]}}\hspace{.1cm})\times1_{\texttt{[feat=1]}}$
</center>

## Run the model

```{r, echo = TRUE, eval = FALSE, fig.height = 4, fig.align='center'}

reg_oj3 <- lm(log(sales) ~ log(price)*brand*feat, 
             data=oj)
stargazer(reg_oj1, reg_oj2, reg_oj3, type = "html", omit = c("Constant"))
```

## Result {.smaller}

```{r results = "asis", echo = FALSE, eval = TRUE, out.height = "50%", fig.align='center'}

reg_oj3 <- lm(log(sales) ~ log(price)*brand*feat, 
             data=oj)
stargazer(reg_oj1, reg_oj2, reg_oj3, type = "html", omit = c("Constant"))
```

## Regression lines
```{r, include = FALSE, out.height = "75%", fig.align='center'}
feat_names <- c(`0` = "no ad", `1` = "ad")
```

```{r, echo = TRUE, eval = TRUE, fig.height = 4, fig.align='center', warning = FALSE, message = FALSE}

ggplot(data = oj, aes(x = log(price), y = log(sales), color = brand )) +
  geom_point(size = .75, alpha = 0.25) +
  geom_smooth(method=lm) +
  facet_grid( . ~ feat, labeller = as_labeller(feat_names))

```


## Price elasticities of OJ {.font size="1"}

```{r, echo = FALSE, eval = TRUE, out.height = "75%", fig.align='center'}
coef1 <-  coef(reg_oj1)
coef2 <-  coef(reg_oj2)
coef3 <-  coef(reg_oj3)
elasticity <- data.frame(
  "dominicks" = c(coef1['log(price)'],coef2['log(price)'],coef3['log(price)'],coef3['log(price)']+coef3['log(price):feat']),
  "minute.maid" = c(coef1['log(price)'],
                coef2['log(price)']+coef2['log(price):brandminute.maid'], coef3['log(price)']+coef3['log(price):brandminute.maid'], coef3['log(price)']+coef3['log(price):brandminute.maid']+coef3['log(price):feat']+coef3['log(price):brandminute.maid:feat']),
  "tropicana" = c(coef1['log(price)'],
                coef2['log(price)']+coef2['log(price):brandtropicana'], coef3['log(price)']+coef3['log(price):brandtropicana'], coef3['log(price)']+coef3['log(price):brandtropicana']+coef3['log(price):feat']+coef3['log(price):brandtropicana:feat'])
  )
row.names(elasticity) <- c("Model 1", "Model 2", "Model 3 w/ no ad", "Model 3 w/ ad")

knitr::kable(round(elasticity,1), "simple")   
```

&nbsp;

- Which model is better?

  - Which model is more realistic?
  
  - Why does being featured always lead to more price sensitivity?



## The relationship between ad and brand

```{r, include = FALSE, out.height = "75%", fig.align='center'}
by_brand <- group_by(oj, brand, feat)
salestable <- summarize(by_brand, 
                        sales_tot = 
                          sum(sales, na.rm = TRUE)
                        )
salestable <- salestable %>% group_by(feat) %>% 
  mutate(sales_prop = sales_tot/sum(sales_tot))

feat_names <- c(`0` = "no ad", `1` = "ad")
```

```{r, echo = TRUE, eval = TRUE, fig.height = 3.5, fig.align='center'}
ggplot(data = salestable) +
  geom_bar(mapping = aes(x = factor(feat), y = sales_prop, 
                         fill = brand), stat = "identity") + 
  xlab("feat") + ylab("proportion of sales") +
  scale_x_discrete(breaks=c(0, 1), labels=c("no ad", "ad"))
```



## Residual plot and model fit

```{r include=FALSE}
# Gets the predicted log(sales) from three different models
oj$predLogSales1 <- predict(reg_oj1, newdata = oj)
oj$predLogSales2 <- predict(reg_oj2, newdata = oj)
oj$predLogSales3 <- predict(reg_oj3, newdata = oj)
```
- Which model is better?

  - On average, are the predictions correct?

  - Are there systematic errors in prediction?

## Residual plot for model 1

```{r, echo = TRUE, eval = TRUE, fig.height = 3.8, fig.align='center', warning=FALSE, message=FALSE}
# Residual plot 1
ggplot(data = oj, aes(x = predLogSales1, y = log(sales) - predLogSales1 )) +
  geom_point(alpha = 0.2, color = "orange") + geom_smooth(color = "darkblue") +
  geom_line(aes(x = predLogSales1, y = 0), color = "red", linetype = 2) +
  xlab("prediction") + ylab("residual error (actual - prediction)")
```



## Residual plot for model 2

```{r, echo = TRUE, eval = TRUE, fig.height = 3.8, fig.align='center', warning=FALSE, message=FALSE}
# Residual plot 2
ggplot(data = oj, aes(x = predLogSales2, y = log(sales) - predLogSales2 )) +
  geom_point(alpha = 0.2, color = "orange") + geom_smooth(color = "darkblue") +
  geom_line(aes(x = predLogSales2, y = 0), color = "red", linetype = 2) +
  xlab("prediction") + ylab("residual error (actual - prediction)")
```



## Residual plot for model 3

```{r, echo = TRUE, eval = TRUE, fig.height = 3.8, fig.align='center', warning=FALSE, message=FALSE}
# Residual plot 3
ggplot(data = oj, aes(x = predLogSales3, y = log(sales) - predLogSales3 )) +
  geom_point(alpha = 0.2, color = "orange") + geom_smooth(color = "darkblue") +
  geom_line(aes(x = predLogSales3, y = 0), color = "red", linetype = 2) +
  xlab("prediction") + ylab("residual error (actual - prediction)")
```

